version: '3.8'

name: tanzania-ai

services:
  n8n-postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: n8n
      POSTGRES_USER: n8n
      POSTGRES_PASSWORD: n8n
    volumes:
      - n8n_postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U n8n -d n8n"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - tanzania-network

  # docling:
  #   image: ghcr.io/docling-project/docling-serve-cpu:v1.8.0
  #   container_name: docling_model
  #   restart: unless-stopped
  #   ports:
  #     - "5001:5001"
  #   environment:
  #     DOCLING_SERVE_ENABLE_UI: true
  #   networks:
  #     - tanzania-network

  ollama:
    image: ollama/ollama:0.13.0
    container_name: ollama
    restart: unless-stopped
    ports:
      - "11435:11434"
    volumes:
      - ollama_data:/root/.ollama
    entrypoint: /bin/sh
    command:
      - "-c"
      - "ollama serve & sleep 5 && ollama pull embeddinggemma:300m && wait"
    networks:
      - tanzania-network

  n8n:
    image: docker.n8n.io/n8nio/n8n:1.120.1
    restart: unless-stopped
    ports:
      - "5678:5678"
    environment:
      N8N_FEATURE_FLAG_MCP: 'true'
      DB_TYPE: postgresdb
      DB_POSTGRESDB_HOST: n8n-postgres
      DB_POSTGRESDB_PORT: 5432
      DB_POSTGRESDB_DATABASE: n8n
      DB_POSTGRESDB_USER: n8n
      DB_POSTGRESDB_PASSWORD: n8n
      GENERIC_TIMEZONE: Europe/Berlin
      TZ: Europe/Berlin
      N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS: 'true'
      N8N_RUNNERS_ENABLED: 'true'
      N8N_HOST: 0.0.0.0
      N8N_PORT: 5678
      N8N_PROTOCOL: http
      NODE_ENV: production
    volumes:
      - n8n_data:/home/node/.n8n
      - ./n8n:/home/external:rw
    depends_on:
      n8n-postgres:
        condition: service_healthy
    networks:
      - tanzania-network

  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant
    restart: unless-stopped
    ports:
      - "6333:6333"  # REST API
      - "6334:6334"  # gRPC API
    volumes:
      - qdrant_data:/qdrant/storage
      - ./qdrant:/qdrant/config
    environment:
      - QDRANT__SERVICE__API_KEY=64f57fc04ea02d7f44ff52c2400ea11044d230343851a2f116a96bfaa6b98471
      - QDRANT__LOG_LEVEL=INFO
      - QDRANT__SERVICE__HTTP_PORT=6333
      - QDRANT__SERVICE__GRPC_PORT=6334
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '4.0'
    networks:
      - tanzania-network

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: frontend
    ports:
      - "1337:3000"
    volumes:
      - ./frontend:/app
      - /app/node_modules
    environment:
      - NODE_ENV=development
      - NEXT_PUBLIC_SUPABASE_URL=http://kong:8000
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${ANON_KEY}
      - SUPABASE_SERVICE_ROLE_KEY=${SERVICE_ROLE_KEY}
    networks:
      - tanzania-network
    
  test-db:
    image: postgres:16-alpine
    container_name: test-db
    environment:
      POSTGRES_DB: ${TEST_DB}
      POSTGRES_USER: ${TEST_DB_USER}
      POSTGRES_PASSWORD: ${TEST_DB_PASSWORD}
    ports:
      - "1339:5432"
    volumes:
      - test_db_data:/var/lib/postgresql/data
      - ./init-test-db:/docker-entrypoint-initdb.d:ro
    networks:
      - tanzania-network

  claims-rec-mcp:
    build:
      context: ./claims-rec-mcp
      dockerfile: Dockerfile
    container_name: claims-rec-mcp
    ports:
      - "7711:7711"
    volumes:
      - ./claims-rec-mcp:/app
    environment:
      TEST_DB: ${TEST_DB}
      TEST_DB_USER: ${TEST_DB_USER}
      TEST_DB_PASSWORD: ${TEST_DB_PASSWORD}
      TEST_DB_HOST: test-db
      TEST_DB_PORT: 5432
    networks:
      - tanzania-network
    restart: unless-stopped

  paddleocr:
    build:
      context: ./paddleocr
      dockerfile: Dockerfile
    container_name: paddleocr
    ports:
      - "5002:5002"
    volumes:
      - ./paddlex_models:/root/.paddlex/official_models:rw
    networks:
      - tanzania-network

volumes:
  n8n_data:
  n8n_postgres-data:
  qdrant_data:
  test_db_data:
  ollama_data:

networks:
  tanzania-network:
    driver: bridge
